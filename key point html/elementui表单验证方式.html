<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="gray-bg" id="123">
<div class="wrapper wrapper-content">
    <div id="list" class="row" v-cloak>
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <div class="form-inline">
                        <h5>商场补贴发票相关选项配置</h5>
                    </div>
                    <div class="ibox-tools">
                        <a class="" @click="reset()">
                            <i class="fa fa-refresh"></i> 刷新
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <el-form :model="ruleForm" ref="ruleForm" label-width="180px" class="demo-ruleForm">
                        <el-form-item
                            v-for="(item, index) in ruleForm.deduction"
                            :label="index === 0 ? '补贴异常扣款原因:': ''"
                            :prop="'deduction.' + index + '.name'"
                            :key="index"
                            :rules="[{ required: true, message: '补贴异常扣款原因不能为空', trigger: 'blur' }, { validator: (rule, value, callback) => { validateName(rule, value, callback) }, trigger: 'blur' }]"
                        >
                            <el-col :span="11">
                                <el-input maxlength="20" v-model="ruleForm.deduction[index].name"></el-input>
                            </el-col>
                            <span class="m-r-md" style="display: inline-block;width: 20px;text-align: center"></span>
                            <el-button size="small" type="danger" @click="delDeduction(index)" showtype="delete">删除</el-button>
                            <el-button size="small" type="primary" @click="addDeduction" v-if="index === deductionLength - 1" showtype="add">添加</el-button>
                        </el-form-item>
                        <el-form-item
                            v-for="(item, index) in ruleForm.invoice"
                            :key="index"
                            :label="index === 0 ? '发票税率:' : ''"
                            :prop="'invoice.' + index + '.name'"
                            :rules="[{ required: true, message: '发票税率不能为空', trigger: 'blur' }, { type: 'number', message: '发票税率必须为数字值'}, { validator: (rule, value, callback) => { validatePass(rule, value, callback) }, trigger: 'blur' }]"
                        >
                            <el-col :span="11">
                                <el-input v-model.number="ruleForm.invoice[index].name" autocomplete="off"></el-input>
                            </el-col>
                            <span class="m-r-md" style="display: inline-block;width: 20px;text-align: center">%</span>
                            <el-button size="small" type="danger" @click="delInvoice(index)" showtype="delete">删除</el-button>
                            <el-button size="small" type="primary" @click="addInvoice" v-if="index === invoiceLength - 1" showtype="add">添加</el-button>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="submitForm"  showtype="submit" >提交</el-button>
                            <!-- <el-button type="danger" @click='cancelForm'>取消</el-button> -->
                        </el-form-item>
                    </el-form>
                </div>
            </div>
        </div>
    </div>
</div>

<!--vue代码-->
<script src="js/vue.min.js"></script>
<script>
    // vue 设置
    var vm = new Vue({
        el: '#list',
        mixins: [],
        data () {
            return {
                // 表单
                ruleForm: {
                    // 异常扣款原因
                    deduction: [
                        {
                            name: ''
                        }
                    ],
                    // 发票税率
                    invoice: [
                        {
                            name: null,
                        }
                    ]
                },
                // 保存时发送异常扣款原因
                text1: [],
                // 保存时发送发票税率
                text2: [],
                // 异常扣款原因数组长度
                deductionLength: 1,
                // 发票税率数组长度
                invoiceLength: 1
            }
        },
        mounted () {
        },
        methods: {
            // 异常扣款原因验证规则
            validateName (rule, value, callback) {
                var deduction = this.ruleForm.deduction,flag = 0;
                deduction.forEach(item => {
                    if (item.name === value) {
                        flag++
                        
                    }
                })
                if (flag > 1) {
                    callback(new Error('异常扣款原因重复'));
                } else {
                    callback();
                }
            },
            // 发票税率验证规则
            validatePass (rule, value, callback) {
                var invoice = this.ruleForm.invoice,flag = 0;
                invoice.forEach(item => {
                    if (item.name === value) {
                        flag++
                    }
                })
                if (value > 100 || value < 0) {
                    callback(new Error('发票税率不能大于100或小于0'));
                } else if (flag > 1) {
                    callback(new Error('发票税率重复'));
                } else {
                    callback();
                }
            }
        }
    });
</script>

</body>

</html>
